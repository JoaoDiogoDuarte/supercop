# -*- Makefile -*-

-include ../../../../Makefile.conf

CC     ?= /usr/bin/cc
CFLAGS := -Wall -Wextra -Wpedantic -Wmissing-prototypes -Wredundant-decls -Wshadow -Wpointer-arith -mavx2 -mbmi2 -mpopcnt -maes -march=native -mtune=native -O3 -fomit-frame-pointer -L. -l25519 -lrandombytes
OS     := $(shell uname -s)

default: test

test: test/test_kem_functionality test/test_speed

# KYBERHEADERS =  ../../kyber/ref/params.h ../../kyber/ref/kem.h ../../kyber/ref/indcpa.h ../../kyber/ref/polyvec.h ../../kyber/ref/poly.h ../../kyber/ref/randombytes.h ../../kyber/ref/ntt.h ../../kyber/ref/cbd.h ../../kyber/ref/reduce.c ../../kyber/ref/verify.h ../../kyber/ref/symmetric.h
HEADERS =  kem.h params.h fips202.h
TESTHEADERS = $(HEADERS) test/cpucycles.h test/speed_print.h

# KYBERSOURCES =  ../../kyber/ref/kem.c ../../kyber/ref/indcpa.c ../../kyber/ref/polyvec.c ../../kyber/ref/poly.c ../../kyber/ref/randombytes.c ../../kyber/ref/ntt.c ../../kyber/ref/cbd.c ../../kyber/ref/reduce.c ../../kyber/ref/verify.c ../../kyber/ref/fips202.c ../../kyber/ref/symmetric-shake.c
SOURCES =  kem.c fips202.c
TESTSOURCES = $(SOURCES) test/cpucycles.c test/speed_print.c 

test/test_kem_functionality: $(TESTSOURCES) $(TESTHEADERS) test/test_kem_functionality.c
	$(CC) $(CFLAGS) -Dkyber_K=3 $(TESTSOURCES) test/test_kem_functionality.c -o $@ -L. -lpqcrystals_kyber768_ref

test/test_speed: $(TESTSOURCES) $(TESTHEADERS) test/test_speed.c
	$(CC) $(CFLAGS) -Dkyber_K=3 $(TESTSOURCES) test/test_speed.c -o $@ -L. -lpqcrystals_kyber768_ref

.PHONY: clean

clean:
	-rm -f test/test_kem_functionality
	-rm -f test/test_speed
	-rm -f *.s
ifeq ($(OS),Darwin)
	-rm -rf test/*.dSYM
endif
